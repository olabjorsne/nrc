<!--
  Copyright Tomas Frisberg & Ola Björsne

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="nrc-tcp-in">
    <div class="form-row">
        <label for="node-input-role"><i class="fa fa-dot-circle-o"></i><span>Role</span></label>
        <select id="node-input-role" style="width:120px; margin-right:5px;">
            <option value="server">Server</option>
            <option value="client">Client</option>
        </select>
        <span>port</span> <input type="text" id="node-input-port" style="width:65px">
    </div>
    <div class="form-row hidden" id="node-input-host-row" style="padding-left: 110px;">
        <span>at host</span> <input type="text" id="node-input-host" placeholder="localhost" style="width: 60%;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-sign-out"></i> <span>Msg Type</span></label>
        <select id="node-input-msgtype" style="width:150px;">
            <option value="dataavailable">Data available</option>
            <option value="buf">Buffer</option>
        </select>
    </div>
    <div class="form-row hidden" id="node-input-bufsize-row">
        <label for="node-input-bufsize"><i class="fa fa-tag"></i> Buf size</label>
        <input type="text" id="node-input-bufsize" placeholder="256">
    </div>
    <div class="form-row">
        <label for="node-input-priority"><i class="fa fa-tag"></i> Priority</label>
        <input type="text" id="node-input-priority" placeholder="8">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span></span>Topic</label>
        <input type="text" id="node-input-topic" placeholder="My topic">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span>Name</span></label>
        <input type="text" id="node-input-name" placeholder="My name">
    </div>
</script>

<script type="text/x-red" data-help-name="nrc-tcp-in">
    <p>Provides a choice of TCP inputs. Can either connect to a remote TCP port,
       or accept incoming connections.</p>
    <p><b>Note: </b>On some systems you may need root or administrator access
    to access ports below 1024.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('nrc-tcp-in',{
        category: 'nrc',
        color:"Silver",
        defaults: {
            name: {value:""},
            role: {value:"server",required:true},
            host: {value:"",validate:function(v) { return (this.role == "server")||v.length > 0;} },
            port: {value:"",required:true,validate:RED.validators.number()},
            msgtype:{value:"buf"},
            bufsize: { value: "256" },
            priority: { value: "8", required: true, validate: RED.validators.number() },
            topic: {value:""}
        },
        inputs:0,
        outputs:1,
        icon: "bridge-dash.png",
        label: function() {
            return this.name || "tcp:"+(this.host?this.host+":":"")+this.port;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var updateOptions = function() {
                var sockettype = $("#node-input-role").val();
                if (sockettype == "client") {
                    $("#node-input-host-row").show();
                } else {
                    $("#node-input-host-row").hide();
                }
                var messagetype = $("#node-input-msgtype").val();
                if (messagetype == "buf") {
                    $("#node-input-bufsize-row").show();
                } else {
                    $("#node-input-bufsize-row").hide();
                }
            };
            updateOptions();
            $("#node-input-role").change(updateOptions);
            $("#node-input-msgtype").change(updateOptions);
        }
    });
</script>
<script type="text/x-red" data-template-name="nrc-tcp-out">
    <div class="form-row">
        <label for="node-input-role"><i class="fa fa-dot-circle-o"></i> <span></span>Role</label>
        <select id="node-input-role" style="width:150px; margin-right:5px;">
            <option value="server">Server</option>
            <option value="client">Client</option>
        </select>
        <span id="node-input-port-row"><span>port</span> <input type="text" id="node-input-port" style="width: 65px"></span>
    </div>

    <div class="form-row hidden" id="node-input-host-row" style="padding-left: 110px;">
        <span>at host</span> <input type="text" id="node-input-host" style="width: 60%;">
    </div>
    <div class="form-row" id="node-input-bufsize-row">
        <label for="node-input-bufsize"><i class="fa fa-tag"></i> Buf size</label>
        <input type="text" id="node-input-bufsize" placeholder="256">
    </div>
    <div class="form-row">
        <label for="node-input-priority"><i class="fa fa-tag"></i> Priority</label>
        <input type="text" id="node-input-priority" placeholder="8">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span>Name</span></label>
        <input type="text" id="node-input-name" placeholder="My name">
    </div>
</script>

<script type="text/x-red" data-help-name="nrc-tcp-out">
    <p>Provides a choice of TCP outputs. Can either connect to a remote TCP port,
    accept incoming connections, or reply to messages received from a TCP In node.</p>
    <p>Only the <code>msg.payload</code> is sent.</p>
    <p>If <code>msg.payload</code> is a string containing a Base64 encoding of binary
    data, the Base64 decoding option will cause it to be converted back to binary
    before being sent.</p>
    <p>If <code>msg._session</code> is not present the payload is
    sent to <b>all</b> connected clients.</p>
    <p><b>Note: </b>On some systems you may need root or administrator access
    to access ports below 1024.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('nrc-tcp-out',{
        category: 'nrc',
        color:"Silver",
        defaults: {
            role: { value: "server", required: true },
            host: { value: "", validate: function (v) { return (this.role == "server") || v.length > 0; } },
            port: { value: "", required: true, validate: RED.validators.number() },
            bufsize: { value: "256" },
            priority: { value: "8", required: true, validate: RED.validators.number() },
            name: {value:""}
        },
        inputs:1,
        outputs:0,
        icon: "bridge-dash.png",
        align: "right",
        label: function() {
            return this.name || "tcp:"+(this.host?this.host+":":"")+this.port;
        },
        labelStyle: function() {
            return (this.name)?"node_label_italic":"";
        },
        oneditprepare: function() {
            var updateOptions = function() {
                var sockettype = $("#node-input-role").val();
                if (sockettype == "client") {
                    $("#node-input-host-row").show();
                } else {
                    $("#node-input-host-row").hide();
                }
            };
            updateOptions();
            $("#node-input-role").change(updateOptions);
        }
    });
</script>


<script type="text/x-red" data-template-name="nrc-tcp-request">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-globe"></i> <span>Server</span></label>
        <input type="text" id="node-input-server" placeholder="ip.address" style="width:45%">
        <span>port</span>
        <input type="text" id="node-input-port" style="width:60px">
    </div>
    <div class="form-row">
        <label for="node-input-out"><i class="fa fa-sign-out"></i> <span>Return</span></label>
        <select type="text" id="node-input-out" style="width:54%;">
            <option value="time">after a fixed timeout of</option>
            <option value="char">when character received is</option>
            <option value="count">a fixed number of chars</option>
            <option value="sit">never - keep connection open</option>
            <option value="immed">immediately - dont wait for replay</option>
        </select>
        <input type="text" id="node-input-splitc" style="width:50px;">
        <span id="node-units"></span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span>Name</span></label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="nrc-tcp-request">
    <p>A simple TCP request node - sends the <code>msg.payload</code> to a server tcp port and expects a response.</p>
    <p>Connects, sends the "request", and reads the "response". It can either count a number of
    returned characters into a fixed buffer, match a specified character before returning,
    wait a fixed timeout from first reply and then return, sit and wait for data, or send then close the connection
    immediately, without waiting for a reply.</p>
    <p>The response will be output in <code>msg.payload</code> as a buffer, so you may want to .toString() it.</p>
    <p>If you leave tcp host or port blank they must be set by using the <code>msg.host</code> and <code>msg.port</code> properties.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('nrc-tcp-request',{
        category: 'nrc',
        color:"Silver",
        defaults: {
            server: {value:""},
            port: {value:"",validate:RED.validators.regex(/^(\d*|)$/)},
            out: {value:"time",required:true},
            splitc: {value:"0",required:true},
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "bridge-dash.png",
        label: function() {
            return this.name || "tcp:"+(this.server?this.server+":":"")+this.port;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var previous = null;
            $("#node-input-out").on('focus', function () { previous = this.value; }).change(function() {
                if (previous === null) { previous = $("#node-input-out").val(); }
                if ($("#node-input-out").val() == "char") {
                    if (previous != "char") { $("#node-input-splitc").val("\\n"); }
                    $("#node-units").text("");
                }
                else if ($("#node-input-out").val() == "time") {
                    if (previous != "time") { $("#node-input-splitc").val("0"); }
                    $("#node-units").text(RED._("node-red:tcpin.label.ms"));
                }
                else if ($("#node-input-out").val() == "immed") {
                    if (previous != "immed") { $("#node-input-splitc").val(" "); }
                    $("#node-units").text("");
                }
                else if ($("#node-input-out").val() == "count") {
                    if (previous != "count") { $("#node-input-splitc").val("12"); }
                    $("#node-units").text(RED._("node-red:tcpin.label.chars"));
                }
                else {
                    if (previous != "sit") { $("#node-input-splitc").val(" "); }
                    $("#node-units").text("");
                }
            });
        }
    });
</script>
